(function() {
  var csrfSafeMethod, getCookie, sameOrigin;

  csrfSafeMethod = function(method) {
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
  };

  sameOrigin = function(url) {
    var host, origin, protocol, sr_origin;
    host = document.location.host;
    protocol = document.location.protocol;
    sr_origin = "//" + host;
    origin = protocol + sr_origin;
    return (url === origin || url.slice(0, origin.length + 1) === origin + "/") || (url === sr_origin || url.slice(0, sr_origin.length + 1) === sr_origin + "/") || !(/^(\/\/|http:|https:).*/.test(url));
  };

  getCookie = function(name) {
    var cookie, cookieValue, cookies, i;
    cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      cookies = document.cookie.split(";");
      i = 0;
      while (i < cookies.length) {
        cookie = jQuery.trim(cookies[i]);
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
        i++;
      }
    }
    return cookieValue;
  };

  window.PopoverWidget = (function() {

    function PopoverWidget(el) {
      var self;
      this.el = el;
      this.template = $("#context-menu-content").html();
      this.imageId = $(this.el).data("image-id");
      self = this;
      $(this.el).bind("click", function() {
        var e;
        e = $(this);
        e.unbind("click");
        return $.ajax({
          url: "/lists/getall/",
          type: "post",
          dataType: "json",
          data: {
            image_id: self.imageId
          },
          success: function(data) {
            if (!data.success) {
              return alert(data.error);
            } else {
              self.initPopover(data);
              return self.showPopover();
            }
          },
          error: function(xhr, err) {
            return alert("Error");
          }
        });
      });
    }

    PopoverWidget.prototype.render = function(data) {
      return Mustache.render(this.template, data);
    };

    PopoverWidget.prototype.initPopover = function(data) {
      var self, tip;
      self = this;
      $(this.el).popover({
        html: true,
        content: this.render({
          imageId: this.imageId,
          lists: data.lists
        })
      });
      tip = $(this.el).data("popover").tip();
      tip.on("submit", ".add-list", function() {
        $.ajax({
          url: "/lists/new/",
          type: "post",
          dataType: "json",
          data: $(this).serialize(),
          success: function(data) {
            if (!data.success) {
              return alert(data.error);
            } else {
              return self.updatePopover(data);
            }
          },
          error: function(xhr, err) {
            return alert("Error");
          }
        });
        return false;
      });
      tip.on("change", ":checkbox", function() {
        var $checkbox, url;
        $checkbox = $(this);
        url = $checkbox.is(':checked') ? "/lists/add/" : "/lists/remove/";
        return $.ajax({
          url: url,
          type: "post",
          dataType: "json",
          data: {
            image_id: self.imageId,
            list_id: $checkbox.val()
          },
          success: function(data) {
            if (!data.success) {
              return alert(data.error);
            } else {
              return self.updatePopover(data);
            }
          },
          error: function(xhr, err) {
            return alert("Error");
          }
        });
      });
    };

    PopoverWidget.prototype.updatePopover = function(data) {
      var tip;
      tip = $(this.el).data("popover").tip();
      $(".popover-content", tip).html(this.render({
        imageId: this.imageId,
        lists: data.lists
      }));
    };

    PopoverWidget.prototype.showPopover = function() {
      return $(this.el).popover("show");
    };

    return PopoverWidget;

  })();

  $(function() {
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        var csrftoken;
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
          csrftoken = getCookie("csrftoken");
          return xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
    return $(".context-menu-btn").each(function() {
      var pw;
      pw = new PopoverWidget(this);
      return $(this).data("popoverwidget", pw);
    });
  });

}).call(this);

// Generated by CoffeeScript 1.5.0-pre
